<html>
    <head>
        <title>Github UI</title>
        <script>
            const pageSize = 10;
            async function processInput() {
                const pieces = input.value.split(' ');

                const commandName = document.createElement('b');
                commandName.append(input.value); // Security note, this won't emit tags
                messageElement(commandName);

                const command = pieces.shift();

                if (!commands[command]) {
                    message('unknown command');
                    commands.help();
                } else {
                    try {
                        await commands[command](...pieces);
                    } catch (exception) {
                        messageError(exception);
                    }
                }
                output.appendChild(document.createElement('br'));
            }

            const commands = {
                async help(command) {
                    if (!!command) {
                        message(`<${command}> parameters:`);
                        if (command in commands) {
                            for (const parameter in commands[command].parameters){
                                message(`â€¢ ${parameter}: ${commands[command].parameters[parameter]}`);
                            }
                        } else {
                            message('no help available for that command');
                        }

                    } else {
                        message('Valid commands:')
                        for (const command in commands) {
                            message(command);
                        }
                    }
                },
                // async security() {
                // TODO: Add this back in when needed for authentication.
                //     message('Is this website secure?');
                //     message('Good question. This does not save any cookies, just local memory. It does not make any external requests other than those you specify. It is just a simple site; take a look for yourself.')
                // },
                async topic(topicName, page=1) {
                    if (!topicName) {
                        return commands.help('topic');
                    }
                    message('requesting. Please wait...');
                    const topics = await asyncGithubTopicSearch(topicName, page);
                    message(`Page ${page} of ${Math.ceil(topics.total_count/pageSize)} (total=${topics.total_count})`);
                    for(const repository of topics.items) {
                        await asyncMessageRepository(repository);
                    }
                },
                async repository(repositoryName) {
                    if (!repositoryName) {
                        return commands.help('repository');
                    }
                    message('requesting. Please wait...')
                    const repository = await asyncGithubRepository(repositoryName);
                    await asyncMessageRepository(repository, "verbose");
                },
            }

            // if only @decorators were supported
            commands.help.parameters = { 
                command: 'the command to get parameter help for',
            }
            commands.topic.parameters = {
                topic: 'the topic you wish to search for',
                '[page]': 'the page number you would like results for (default 1)',
                // TODO: Add in a 'verbosity' parameter which will make the async requests for all of the repositories returned.
            }
            commands.repository.parameters = {
                repositoryName: 'the full name of the repository to get details for',
            }

            function setAndSend(command) {
                input.value = command;
                processInput();
            }

            function messageElement(element, br=true) {
                output.appendChild(element);
                if (br) {
                    output.appendChild(document.createElement('br'));
                }
                input.scrollIntoView();
                input.select();
            }

            async function asyncMessageRepository(repository, verbosity) {
                const element = await asyncRepositoryElement(repository, verbosity);
                messageElement(element, br=false);
            }

            function contributorElement(contributor) {
                const div = document.createElement('div');
                const a = document.createElement('a');
                a.setAttribute('href', contributor.html_url);
                a.setAttribute('target', '_blank');
                const img = document.createElement('img');
                img.setAttribute('src', contributor.avatar_url);
                img.setAttribute('width', 20);
                a.appendChild(img)
                a.append(' ');
                a.append(contributor.login);
                div.appendChild(a);
                return div;
            }

            async function asyncRepositoryElement(repository, verbosity) {
                const div = document.createElement('div');
                const a = document.createElement('a');
                a.setAttribute('href', repository.html_url);
                a.setAttribute('target', '_blank');
                a.append(repository.full_name);
                div.appendChild(a);
                div.append(' ');
                if (!verbosity) {
                    const button = document.createElement('button');
                    button.setAttribute('type', 'button');
                    button.setAttribute('onclick', `setAndSend('repository ${repository.full_name}')`);
                    button.innerText = 'verbose';
                    div.append(button);
                }
                div.append(' ');
                div.append(repository.description);
                if (!!verbosity) {
                    const contributorsPromise = asyncGithub(repository.contributors_url);
                    const topicsPromise = asyncGithubRepoTopics(repository.full_name);
                    // this is a delayed await so they both happen simultaneously
                    const contributors = await contributorsPromise;
                    const topics = await topicsPromise;

                    const topicsDiv = document.createElement('div');
                    topicsDiv.append('Topics:');
                    topicsDiv.append(topics.names.join(', '));
                    div.appendChild(topicsDiv);

                    const contributorsDiv = document.createElement('div');
                    contributorsDiv.append('Contributors:');
                    for (const contributor of contributors) {
                        contributorsDiv.appendChild(contributorElement(contributor));
                    }
                    div.appendChild(contributorsDiv);

                    messageElement(div, br=false);
                }
                return div;
            }

            function message(content) {
                messageElement(document.createTextNode(content));
            }

            function messageError(content) {
                message('Error:')
                // TODO: maybe make this red
                message(content);
            }

            function asyncGithub(url) {
                return new Promise((resolve, reject) => {
                    const request = new XMLHttpRequest();
                    request.open("GET", url);
                    request.setRequestHeader('Accept', 'application/vnd.github.mercy-preview+json');
                    request.onreadystatechange=(e)=>{
                        if(request.readyState === XMLHttpRequest.DONE) {
                            if (request.status === 0 || (request.status >= 200 && request.status < 400)) {
                                let responseObject;
                                try {
                                    responseObject = JSON.parse(request.responseText);
                                } catch {
                                    reject('invalid json from github API');
                                }
                                resolve(responseObject);
                            } else {
                                reject(request.responseText);
                            }
                        }
                    }
                    request.send();
                });
            }

            async function asyncGithubRepoTopics(repositoryName) {
                return await asyncGithub(`https://api.github.com/repos/${repositoryName}/topics`);
            }

            async function asyncGithubTopicSearch(message, page, callback) {
                return await asyncGithub(`https://api.github.com/search/repositories?per_page=${pageSize}&page=${page}&q=topic:${message}`);
            }

            async function asyncGithubRepository(repositoryName, callback) {
                return await asyncGithub(`https://api.github.com/repos/${repositoryName}`);
            }

        </script>
    </head>
    <body>
        <div id="output"></div>
        <form action="javascript:processInput()">
            <input id="input" type="text" value="help" autocomplete="off"/>
            <input type="submit" />
        </form>
    </body>
    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        input.focus();
        input.select();
    </script>
</html>