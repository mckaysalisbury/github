<html>
    <head>
        <title>Github UI</title>
        <script>
            const pageSize = 10;
            function processInput() {
                const pieces = input.value.split(' ');

                const commandName = document.createElement('b');
                commandName.append(input.value); // this won't emit tags
                messageElement(commandName);

                const command = pieces.shift();

                if (!commands[command]) {
                    message('unknown command');
                    commands.help();
                } else {
                    commands[command](...pieces);
                }
                output.appendChild(document.createElement('br'));
            }

            const commands = {
                help(command) {
                    if (!!command) {
                        message(`<${command}> parameters:`);
                        if (command in commands) {
                            for (parameter in commands[command].parameters){
                                message(`â€¢ ${parameter}: ${commands[command].parameters[parameter]}`);
                            }
                        } else {
                            message('no help available for that command');
                        }

                    } else {
                        message('Valid commands:')
                        for (const command in commands) {
                            message(command);
                        }
                    }
                },
                security() {
                    message('Is this website secure?');
                    message('Good question. This does not save any cookies, just local memory. It does not make any external requests other than those you specify. It is just a simple site; take a look for yourself.')
                },
                topic(topicName, page=1) {
                    if (!topicName) {
                        return commands.help('topic');
                    }
                    message('requesting. Please wait...');
                    githubTopics(topicName, page, (response) => {

                        message(`Page ${page} of ${Math.ceil(response.total_count/pageSize)} (total=${response.total_count})`);
                        for(repository of response.items) {
                            messageRepository(repository);
                        }
                        message('');
                    });
                },
                repository(repositoryName) {
                    if (!repositoryName) {
                        return commands.help('repository');
                    }
                    message('requesting. Please wait...')
                    githubRepository(repositoryName, (response) => {
                        messageRepository(response, "verbose");
                    });
                },
            }

            // if only @decorators were supported
            commands.help.parameters = { 
                command: 'the command to get parameter help for',
            }
            commands.topic.parameters = {
                topic: 'the topic you wish to search for',
                '[page]': 'the page number you would like results for (default 1)',
            }
            commands.repository.parameters = {
                repositoryName: 'the full name of the repository to get details for',
            }

            function setAndSend(command) {
                input.value = command;
                processInput();
            }

            function messageElement(element, br=true) {
                output.appendChild(element);
                if (br) {
                    output.appendChild(document.createElement('br'));
                }
                input.scrollIntoView();
                input.select();
            }

            function messageRepository(repository, verbosity) {
                const div = document.createElement('div');
                const a = document.createElement('a');
                a.setAttribute('href', repository.html_url);
                a.setAttribute('target', '_blank');
                a.append(repository.full_name);
                div.appendChild(a);
                div.append(' ');
                if (!verbosity) {
                    const button = document.createElement('button');
                    button.setAttribute('type', 'button');
                    button.setAttribute('onclick', `setAndSend('repository ${repository.full_name}')`);
                    button.innerText = 'verbose';
                    div.append(button);
                }
                div.append(' ');
                div.append(repository.description);
                if (!!verbosity) {
                    // Hmm, maybe I should convert this to Promise style, instead of chaining for efficiency

                    { // in the callback
                        messageElement(div, br=false);
                    }
                } else {
                    // the callback will call this in verbosity mode
                    messageElement(div, br=false);
                }
            }

            function message(content) {
                messageElement(document.createTextNode(content));
            }

            function error(content) {
                message('Error:')
                // maybe make this red
                message(content);
            }

            function githubApi(url, callback) {
                const request = new XMLHttpRequest();
                console.log(url);
                request.open("GET", url);
                request.setRequestHeader('Accept', 'application/vnd.github.v3+json');
                request.onreadystatechange=(e)=>{
                    if(request.readyState === XMLHttpRequest.DONE) {
                        if (request.status === 0 || (request.status >= 200 && request.status < 400)) {
                            let responseObject;
                            try {
                                responseObject = JSON.parse(request.responseText);
                            } catch {
                                error('invalid json from github API');
                            }
                            callback(responseObject);
                        } else {
                            error('There was a problem making the web request. See the log for more information.');
                            console.error(request.responseText);
                        }
                    }
                }
                request.send();
            }

            function githubTopics(message, page, callback) {
                githubApi(`https://api.github.com/search/repositories?per_page=${pageSize}&page=${page}&q=topic:${message}`, callback);
            }

            function githubRepository(repositoryName, callback) {
                githubApi(`https://api.github.com/repos/${repositoryName}`, callback);
            }

        </script>
    </head>
    <body>
        <div id="output"></div>
        <form action="javascript:processInput()">
            <input id="input" type="text" value="help" autocomplete="off"/>
        </form>
    </body>
    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        input.focus();
        input.select();
    </script>
</html>