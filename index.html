<html>
    <head>
        <title>Github UI</title>
        <script>
            function enter() {
                const pieces = input.value.split(' ');

                const commandName = document.createElement('b');
                commandName.append(pieces[0]); // this won't emit tags
                messageElement(commandName);

                const command = pieces.shift();

                if (!commands[command]) {
                    message('unknown command');
                    commands.help();
                } else {
                    commands[command](...pieces);
                }
                output.appendChild(document.createElement('br'));
            }

            function arguments(...arguments) {
                target.arguments = arguments;
                return target;
            }

            const commands = {
                help(command) {
                    if (!!command) {
                        message(`<${command}> parameters:`);
                        if (command in commands) {
                            for (parameter in commands[command].parameters){
                                message(`• ${parameter}: ${commands[command].parameters[parameter]}`);
                            }
                        } else {
                            message('no help available for that command');
                        }

                    } else {
                        message('Valid commands:')
                        for (const command in commands) {
                            message(command);
                        }
                    }
                },
                security() {
                    message('Is this website secure?');
                    message('Good question. This does not save any cookies, just local memory. It does not make any external requests other than those you specify. It is just a simple site; take a look for yourself.')
                },
                topic(topicName) {
                    if (!topicName) {
                        return commands.help('topic');
                    }
                    message('requesting. Please wait...')
                    web(topicName, (response) => {

                        message(`${response.items.length} of ${response.total_count} topics`);
                        for(repository of response.items) {
                            messageRepository(repository, '•');
                        }
                    });
                }
            }

            // if only @decorators were supported
            commands.help.parameters = { 
                command: 'the command to get parameter help for',
            }
            commands.topic.parameters = {
                topic: 'the topic you wish to search for',
            }

            function messageElement(element) {
                output.appendChild(element);
                output.appendChild(document.createElement('br'));
                input.scrollIntoView();
                input.select();
            }

            function messageRepository(repository, prefix='') {
                const a = document.createElement('a');
                a.setAttribute('href', repository.html_url);
                a.setAttribute('target', '_blank');
                a.append(repository.name);
                messageElement(a);
                // message(`${prefix}${repository.name}`);
            }

            function message(content) {
                messageElement(document.createTextNode(content));
            }

            function error(content) {
                message('Error:')
                // maybe make this red
                message(content);
            }

            function web(message, callback) { // this is not a good name. But I don't know what the signature will look like yet
                const request = new XMLHttpRequest();
                const url = `https://api.github.com/search/repositories?q=topic:${message}`;
                request.open("GET", url);
                request.onreadystatechange=(e)=>{
                    if(request.readyState === XMLHttpRequest.DONE) {
                        if (request.status === 0 || (request.status >= 200 && request.status < 400)) {
                            let responseObject;
                            try {
                                responseObject = JSON.parse(request.responseText);
                            } catch {
                                error('invalid json from webserver');
                            }
                            callback(responseObject);
                        } else {
                            error('There was a problem making the web request');
                        }
                    }
                }
                request.send();
            }

        </script>
    </head>
    <body>
        <div id="output"></div>
        <form action="javascript:enter()">
            <input id="input" type="text" value="help"/>
        </form>
    </body>
    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        input.focus();
        input.select();
    </script>
</html>